{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Administrer turnussett</h1>
                <a href="{{ url_for('admin.create_turnus_set') }}" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Opprett nytt turnussett
                </a>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Active Turnus Set Info -->
            {% if active_set %}
            <div class="alert alert-info mb-4">
                <h5><i class="bi bi-info-circle"></i> Nåværende aktivt turnussett</h5>
                <strong>{{ active_set.name }}</strong> ({{ active_set.year_identifier }})
                <br><small>Opprettet: {{ active_set.created_at.strftime('%Y-%m-%d %H:%M') if active_set.created_at else 'Ukjent' }}</small>
            </div>
            {% else %}
            <div class="alert alert-warning mb-4">
                <h5><i class="bi bi-exclamation-triangle"></i> Ingen aktivt turnussett</h5>
                Vennligst opprett og aktiver et turnussett for å begynne å bruke systemet.
            </div>
            {% endif %}

            <!-- Turnus Sets Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Alle turnussett</h5>
                </div>
                <div class="card-body">
                    {% if turnus_sets %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>År-ID</th>
                                    <th>Navn</th>
                                    <th>Status</th>
                                    <th>Strekliste</th>
                                    <th>Opprettet</th>
                                    <th>Handlinger</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for turnus_set in turnus_sets %}
                                <tr>
                                    <td><strong>{{ turnus_set.year_identifier }}</strong></td>
                                    <td>{{ turnus_set.name }}</td>
                                    <td>
                                        {% if turnus_set.is_active %}
                                            <span class="badge bg-success">Aktiv</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inaktiv</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <!-- Strekliste Status and Controls -->
                                        <div class="strekliste-controls" data-turnus-set-id="{{ turnus_set.id }}">
                                            <span class="strekliste-status badge bg-secondary" id="strekliste-status-{{ turnus_set.id }}">
                                                <i class="bi bi-hourglass-split"></i> Laster...
                                            </span>

                                            <!-- Upload form (hidden, triggered by button) -->
                                            <form method="POST" action="{{ url_for('admin.upload_strekliste', turnus_set_id=turnus_set.id) }}"
                                                  enctype="multipart/form-data" class="d-inline" id="upload-form-{{ turnus_set.id }}">
                                                {{ upload_form.hidden_tag() }}
                                                <input type="file" name="pdf_file" accept=".pdf" class="d-none"
                                                       id="pdf-input-{{ turnus_set.id }}" onchange="this.form.submit()">
                                                <button type="button" class="btn btn-sm btn-outline-primary"
                                                        onclick="document.getElementById('pdf-input-{{ turnus_set.id }}').click()"
                                                        title="Last opp strekliste PDF">
                                                    <i class="bi bi-upload"></i>
                                                </button>
                                            </form>

                                            <!-- Generate button -->
                                            <button type="button" class="btn btn-sm btn-outline-success generate-btn"
                                                    id="generate-btn-{{ turnus_set.id }}"
                                                    data-turnus-set-id="{{ turnus_set.id }}"
                                                    onclick="generateStrekliste({{ turnus_set.id }})"
                                                    disabled title="Generer PNG-bilder fra PDF">
                                                <i class="bi bi-image"></i>
                                            </button>

                                            <!-- Delete images button -->
                                            <button type="button" class="btn btn-sm btn-outline-danger delete-images-btn"
                                                    id="delete-images-btn-{{ turnus_set.id }}"
                                                    data-turnus-set-id="{{ turnus_set.id }}"
                                                    onclick="deleteStreklisteImages({{ turnus_set.id }})"
                                                    disabled title="Slett alle genererte bilder">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td>{{ turnus_set.created_at.strftime('%Y-%m-%d') if turnus_set.created_at else 'Ukjent' }}</td>
                                    <td>
                                        {% if not turnus_set.is_active %}
                                        <form method="POST" action="{{ url_for('admin.switch_turnus_set') }}" style="display: inline;">
                                            <input type="hidden" name="turnus_set_id" value="{{ turnus_set.id }}">
                                            <button type="submit" class="btn btn-sm btn-primary"
                                                    onclick="return confirm('Sett {{ turnus_set.year_identifier }} som aktivt turnussett?')">
                                                <i class="bi bi-check-circle"></i> Aktiver
                                            </button>
                                        </form>
                                        {% endif %}

                                        <form method="POST" action="{{ url_for('admin.delete_turnus_set', turnus_set_id=turnus_set.id) }}"
                                              style="display: inline;" onsubmit="return confirm('Er du sikker på at du vil slette {{ turnus_set.year_identifier }}? Dette vil også slette alle tilknyttede vakter og favoritter.')">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="bi bi-trash"></i> Slett
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">Ingen turnussett funnet.</p>
                        <a href="{{ url_for('admin.create_turnus_set') }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Opprett første turnussett
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Strekliste Generation Progress Modal -->
<div class="modal fade" id="streklisteProgressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Genererer Strekliste Bilder</h5>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laster...</span>
                    </div>
                </div>
                <p class="text-center" id="progress-text">Prosesserer PDF...</p>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%" id="progress-bar"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load strekliste status for all turnus sets
    document.querySelectorAll('.strekliste-controls').forEach(function(el) {
        const turnusSetId = el.dataset.turnusSetId;
        loadStreklisteStatus(turnusSetId);
    });
});

function loadStreklisteStatus(turnusSetId) {
    fetch(`/admin/strekliste-status/${turnusSetId}`)
        .then(response => response.json())
        .then(data => {
            const statusEl = document.getElementById(`strekliste-status-${turnusSetId}`);
            const generateBtn = document.getElementById(`generate-btn-${turnusSetId}`);
            const deleteBtn = document.getElementById(`delete-images-btn-${turnusSetId}`);

            if (data.status === 'success') {
                const info = data.data;

                if (info.status === 'no_pdf') {
                    statusEl.className = 'strekliste-status badge bg-secondary';
                    statusEl.innerHTML = '<i class="bi bi-x-circle"></i> Ingen PDF';
                    generateBtn.disabled = true;
                    deleteBtn.disabled = true;
                } else if (info.status === 'pdf_ready') {
                    statusEl.className = 'strekliste-status badge bg-warning text-dark';
                    statusEl.innerHTML = '<i class="bi bi-file-earmark-pdf"></i> PDF klar';
                    generateBtn.disabled = false;
                    deleteBtn.disabled = true;
                } else if (info.status === 'images_generated') {
                    statusEl.className = 'strekliste-status badge bg-success';
                    statusEl.innerHTML = `<i class="bi bi-check-circle"></i> ${info.image_count} bilder`;
                    generateBtn.disabled = false;
                    generateBtn.title = 'Regenerer bilder (force)';
                    deleteBtn.disabled = false;
                }
                // Reset button icons (in case they were showing spinners)
                deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
            } else {
                statusEl.className = 'strekliste-status badge bg-danger';
                statusEl.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Feil';
            }
        })
        .catch(error => {
            console.error('Error loading strekliste status:', error);
            const statusEl = document.getElementById(`strekliste-status-${turnusSetId}`);
            statusEl.className = 'strekliste-status badge bg-danger';
            statusEl.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Feil';
        });
}

function generateStrekliste(turnusSetId) {
    // Show progress modal
    const modal = new bootstrap.Modal(document.getElementById('streklisteProgressModal'));
    modal.show();

    const progressText = document.getElementById('progress-text');
    const progressBar = document.getElementById('progress-bar');

    progressText.textContent = 'Starter generering...';
    progressBar.style.width = '10%';

    // Check if we need to force regenerate
    const statusEl = document.getElementById(`strekliste-status-${turnusSetId}`);
    const hasImages = statusEl.textContent.includes('bilder');

    fetch(`/admin/generate-strekliste/${turnusSetId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({ force: hasImages })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            progressBar.style.width = '100%';
            progressBar.classList.add('bg-success');
            progressText.textContent = `Ferdig! ${data.generated} bilder generert, ${data.skipped} hoppet over.`;

            // Reload status after a short delay
            setTimeout(() => {
                modal.hide();
                loadStreklisteStatus(turnusSetId);
                // Reset progress bar
                progressBar.style.width = '0%';
                progressBar.classList.remove('bg-success');
            }, 2000);
        } else {
            progressBar.classList.add('bg-danger');
            progressText.textContent = `Feil: ${data.message}`;
        }
    })
    .catch(error => {
        console.error('Error generating strekliste:', error);
        progressBar.classList.add('bg-danger');
        progressText.textContent = 'En feil oppstod under generering.';
    });
}

function deleteStreklisteImages(turnusSetId) {
    if (!confirm('Er du sikker på at du vil slette alle genererte bilder? Dette kan ikke angres.')) {
        return;
    }

    const deleteBtn = document.getElementById(`delete-images-btn-${turnusSetId}`);
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';

    fetch(`/admin/delete-strekliste-images/${turnusSetId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Reload status to update UI
            loadStreklisteStatus(turnusSetId);
        } else {
            alert(`Feil: ${data.message}`);
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
        }
    })
    .catch(error => {
        console.error('Error deleting strekliste images:', error);
        alert('En feil oppstod under sletting.');
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
    });
}
</script>
{% endblock %}