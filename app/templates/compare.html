{% extends "base.html" %}

{% block title %}Sammenlign Turnuser{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="row g-3 mb-3">
    <div class="col-12 d-flex align-items-center gap-2">
      <label for="order-select" class="form-label m-0">Sorter:</label>
      <select id="order-select" class="form-select form-select-sm" style="width: auto;">
        <option value="asc">Minst → Størst</option>
        <option value="desc" selected>Størst → Minst</option>
      </select>
      <div class="vr mx-2"></div>
      <label for="chart-mode" class="form-label m-0">Visning:</label>
      <select id="chart-mode" class="form-select form-select-sm" style="width: auto;">
        <option value="vertical" selected>Søyle (kolonner)</option>
        <option value="pie">Kakediagram</option>
      </select>
    </div>
  </div>
  <div class="row g-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Dagsverk</h5>
          <div id="wrap-chart-shift_cnt" style="position: relative; height: 360px; overflow: auto;">
            <canvas id="chart-shift_cnt"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Natt</h5>
          <div id="wrap-chart-natt" style="position: relative; height: 360px; overflow: auto;">
            <canvas id="chart-natt"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Tidlig</h5>
          <div id="wrap-chart-tidlig" style="position: relative; height: 360px; overflow: auto;">
            <canvas id="chart-tidlig"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Før 6:00</h5>
          <div id="wrap-chart-before_6" style="position: relative; height: 360px; overflow: auto;">
            <canvas id="chart-before_6"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Helgetimer</h5>
          <div id="wrap-chart-helgetimer" style="position: relative; height: 360px; overflow: auto;">
            <canvas id="chart-helgetimer"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ labels|tojson }};
  const data = {{ data|tojson }};

  const charts = {};

  function buildPalette(count) {
    const colors = [];
    for (let i = 0; i < count; i++) {
      const hue = Math.round((360 / Math.max(count, 1)) * i);
      colors.push(`hsl(${hue} 70% 60% / 0.8)`);
    }
    return colors;
  }

  function computeContainerHeight(numItems) {
    const perItem = 28; // px per bar (more spacing)
    const maxHeight = 500; // cap for readability
    const total = numItems * perItem;
    // Return container cap; canvas will get full height (scrolls inside container)
    return Math.min(total, maxHeight);
  }

  function sortOnly(allLabels, allValues, order) {
    const zipped = allLabels.map((l, i) => ({ l, v: allValues[i] }));
    zipped.sort((a, b) => order === 'asc' ? a.v - b.v : b.v - a.v);
    return { lbls: zipped.map(x => x.l), vals: zipped.map(x => x.v) };
  }

  function destroyChartIfExists(id) {
    if (charts[id]) {
      charts[id].destroy();
      delete charts[id];
    }
  }

  function makeChart(canvasId, labelsArr, valuesArr, label, mode) {
    const wrap = document.getElementById('wrap-' + canvasId);
    const canvasEl = document.getElementById(canvasId);
    // no list element; we rely on scrolling in the chart container
    // Height handling
    if (mode === 'pie') {
      wrap.style.height = '420px';
      canvasEl.style.height = '400px';
      canvasEl.style.width = '100%';
      wrap.style.overflowX = 'hidden';
      wrap.style.overflowY = 'auto';
    } else {
      wrap.style.height = '420px';
      canvasEl.style.height = '400px';
      // Ensure horizontal scrolling space for many columns
      const widthPerBar = 80; // px per column including spacing (increased for readability)
      const minWidth = Math.max(valuesArr.length * widthPerBar, wrap.clientWidth);
      // Important: set both CSS size and canvas pixel attributes
      canvasEl.style.width = minWidth + 'px';
      canvasEl.style.maxWidth = 'unset';
      canvasEl.width = minWidth;
      canvasEl.height = 400;
      wrap.style.overflowX = 'auto';
      wrap.style.overflowY = 'hidden';
      wrap.style.whiteSpace = 'nowrap';
    }
    const ctx = canvasEl.getContext('2d');
    destroyChartIfExists(canvasId);
    const isPie = mode === 'pie';
    const chartType = isPie ? 'pie' : 'bar';
    let useLabels = labelsArr;
    let useValues = valuesArr;
    // show all slices for pie; no grouping
    const palette = buildPalette(useLabels.length);
    const options = {
      responsive: isPie ? true : false,
      maintainAspectRatio: false,
      animation: false,
      scales: isPie ? {} : {
        x: {
          beginAtZero: true,
          ticks: {
            font: { size: 12 },
            autoSkip: false,
            maxRotation: 45,
            minRotation: 0
          }
        },
        y: {
          ticks: {
            autoSkip: false,
            maxRotation: 0,
            minRotation: 0,
            padding: 6,
            font: { size: 14 },
            callback: function(v, i, ticks) {
              const label = this.getLabelForValue(v);
              const maxLen = 24;
              return label.length > maxLen ? label.slice(0, maxLen - 1) + '…' : label;
            }
          }
        }
      },
      indexAxis: isPie ? undefined : 'x',
      plugins: {
        legend: isPie ? { display: true, position: 'right', labels: { boxWidth: 12, font: { size: 12 } } } : { display: false },
        tooltip: {
          callbacks: {
            title: (items) => items[0]?.label || ''
          }
        }
      }
    };
    const datasetCommon = {
      label: label,
      data: useValues,
      backgroundColor: isPie ? palette : palette,
      borderColor: isPie ? palette.map(c => c.replace('/ 0.8', '/ 1')) : palette.map(c => c.replace('/ 0.8', '/ 1')),
      borderWidth: 1,
    };
    if (!isPie) {
      datasetCommon.barThickness = 28; // thicker columns
      datasetCommon.maxBarThickness = 34;
      datasetCommon.categoryPercentage = 0.5; // spacing between groups
      datasetCommon.barPercentage = 0.8; // spacing within group
    }

    charts[canvasId] = new Chart(ctx, {
      type: chartType,
      data: {
        labels: useLabels,
        datasets: [datasetCommon]
      },
      options
    });

    // no extra list rendering
  }

  function renderAll(orderValue) {
    const m = {
      'chart-shift_cnt': { arr: data['shift_cnt'], label: 'Dagsverk' },
      'chart-natt': { arr: data['natt'], label: 'Natt' },
      'chart-tidlig': { arr: data['tidlig'], label: 'Tidlig' },
      'chart-before_6': { arr: data['before_6'], label: 'Før 6:00' },
      'chart-helgetimer': { arr: data['helgetimer'], label: 'Helgetimer' }
    };

    for (const [canvasId, cfg] of Object.entries(m)) {
      const { lbls, vals } = sortOnly(labels, cfg.arr, orderValue);
      makeChart(canvasId, lbls, vals, cfg.label, document.getElementById('chart-mode').value);
    }
  }

  const orderSelect = document.getElementById('order-select');
  const modeSelect = document.getElementById('chart-mode');
  renderAll(orderSelect.value);
  orderSelect.addEventListener('change', () => {
    renderAll(orderSelect.value);
  });
  modeSelect.addEventListener('change', () => {
    renderAll(orderSelect.value);
  });
</script>
{% endblock %}


